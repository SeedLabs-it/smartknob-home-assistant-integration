{"version":3,"file":"with-web-components.esnext.js","sources":["../src/index.ts"],"sourcesContent":["import {\n  twind,\n  cssom,\n  mo as observe,\n  noop,\n  type Sheet,\n  type TwindConfig,\n  type TwindUserConfig,\n} from '@twind/core'\n\nimport { PROD } from 'distilt/env'\n\nexport default function install(\n  config: TwindConfig<any> | TwindUserConfig<any>,\n  isProduction = PROD,\n) {\n  // 1. Create separate adoptable sheet\n  const sheet = adoptable()\n\n  // 2. Use that to create an own twind instance\n  const tw = twind(\n    {\n      ...config,\n      // in production use short hashed class names\n      hash: config.hash ?? isProduction,\n    } as TwindConfig<any>,\n    sheet,\n  )\n\n  // 3. One MutationObserver for all element instances\n  const observer = observe(tw)\n\n  return function install$<\n    T extends {\n      new (...args: any[]): HTMLElement & {\n        connectedCallback?(): void\n        disconnectedCallback?(): void\n      }\n    },\n  >(BaseElement: T) {\n    return class WithTwindElement extends BaseElement {\n      readonly tw = tw\n\n      override connectedCallback() {\n        super.connectedCallback?.()\n        sheet.connect(this)\n        observer.observe(getShadowRoot(this))\n      }\n\n      override disconnectedCallback() {\n        sheet.disconnect(this)\n        super.disconnectedCallback?.()\n      }\n    }\n  }\n}\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var ShadyCSS: { nativeShadow: boolean }\n}\n\n/**\n * Whether the current browser supports `adoptedStyleSheets`.\n * @link https://github.com/lit/lit/blob/393e30cf7c7f97712e524df34e7343147055fc5d/packages/reactive-element/src/css-tag.ts#L13\n */\nconst supportsAdoptingStyleSheets =\n  typeof ShadowRoot !== 'undefined' &&\n  (typeof ShadyCSS === 'undefined' || ShadyCSS.nativeShadow) &&\n  'adoptedStyleSheets' in Document.prototype &&\n  'replace' in CSSStyleSheet.prototype\n\nfunction getShadowRoot(element: HTMLElement): ShadowRoot {\n  return element.shadowRoot || element.attachShadow({ mode: 'open' })\n}\n\ninterface AdoptableSheet extends Sheet<CSSStyleSheet> {\n  connect(element: HTMLElement): void\n  disconnect(element: HTMLElement): void\n}\n\nfunction adoptable(): AdoptableSheet {\n  // TODO: search for SSR stylesheet\n  if (supportsAdoptingStyleSheets) {\n    try {\n      // Try using adoptedStyleSheets — not supported in all browsers\n      const sheet = cssom(new CSSStyleSheet()) as AdoptableSheet\n\n      sheet.connect = (element) => {\n        const shadowRoot = getShadowRoot(element)\n        shadowRoot.adoptedStyleSheets = [...shadowRoot.adoptedStyleSheets, sheet.target]\n      }\n\n      sheet.disconnect = noop\n\n      return sheet\n    } catch {\n      // ignore — continue with fallback\n    }\n  }\n\n  // Fallback: create a dedicated stylesheet for each element instance\n\n  // Create our base stylesheet — its css rules will be copied to each element style\n  const style = document.createElement('style')\n  // Prevent this style sheet from being applied anywhere\n  style.media = 'not all'\n  document.head.prepend(style)\n\n  const sheets = [cssom(style)]\n\n  /** @type {WeakMap<HTMLElement, import('@twind/core').Sheet>} */\n  const sheetsByElement = new WeakMap()\n\n  return {\n    get target() {\n      return sheets[0].target\n    },\n\n    snapshot() {\n      const restores = sheets.map((sheet) => sheet.snapshot())\n      return () => restores.forEach((restore) => restore())\n    },\n\n    clear() {\n      sheets.forEach((sheets) => sheets.clear())\n    },\n\n    destroy() {\n      sheets.forEach((sheets) => sheets.destroy())\n    },\n\n    insert(css, index, rule) {\n      // We first insert the rule into our base sheet\n      // This call will check (try-catch) and warn if necessary\n      sheets[0].insert(css, index, rule)\n\n      // For all connected sheets we insert the resulting rule directly\n      // by-passing the try-catch block\n      const cssRule = this.target.cssRules[index]\n      sheets.forEach(\n        (sheets, notFirst) => notFirst && sheets.target.insertRule(cssRule.cssText, index),\n      )\n    },\n\n    resume(addClassName, insert) {\n      return sheets[0].resume(addClassName, insert)\n    },\n\n    connect(element) {\n      const style = document.createElement('style')\n      getShadowRoot(element).appendChild(style)\n\n      const sheet = cssom(style)\n\n      // Directly copy all rules from our base sheet\n      const { cssRules } = this.target\n      for (let i = 0; i < cssRules.length; i++) {\n        sheet.target.insertRule(cssRules[i].cssText, i)\n      }\n\n      sheets.push(sheet)\n      sheetsByElement.set(element, sheet)\n    },\n\n    disconnect(element) {\n      const index = sheets.indexOf(sheetsByElement.get(element))\n      if (index >= 0) {\n        sheets.splice(index, 1)\n      }\n    },\n  }\n}\n"],"names":["install","config","isProduction","sheet","adoptable","supportsAdoptingStyleSheets","cssom","CSSStyleSheet","connect","element","shadowRoot","getShadowRoot","adoptedStyleSheets","target","disconnect","noop","style","document","createElement","media","head","prepend","sheets","sheetsByElement","WeakMap","snapshot","restores","map","forEach","restore","clear","destroy","insert","css","index","rule","cssRule","cssRules","notFirst","insertRule","cssText","resume","addClassName","appendChild","i","length","push","set","indexOf","get","splice","tw","twind","hash","observer","observe","install$","BaseElement","WithTwindElement","connectedCallback","disconnectedCallback","ShadowRoot","ShadyCSS","nativeShadow","Document","prototype","attachShadow","mode"],"mappings":"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"}